<!DOCTYPE HTML>

<!-- Salve, Regina, Mater misericordiæ
vita, dulcedo, et spes nostra, salve.
Ad te clamamus exsules filii Hevæ
Ad te suspiramus, gementes et flentes
in hac lacrimarum valle.
Eia, ergo, advocata nostra, illos tuos
misericordes oculos ad nos converte;
Et Jesum, benedictum fructum ventris tui
nobis post hoc exsilium ostende.
O clemens, O pia, O dulcis Virgo Maria. -->

<html lang="en">
<head>
<title>Matthew Kudija | Notes</title>
<link rel="shortcut icon" type="image/jpg" href="https://raw.githubusercontent.com/mkudija/mkudija.github.io/master/favicon.ico"/>
<meta name="description" content="Matthew Kudija's reading notes.">
<meta name="keywords" content="matthew, kudija, mkudija, catholic, reading, books">
<link rel="shortcut icon" href="https://github.com/mkudija/mkudija.github.io/blob/master/favicon.ico">
<link rel="next" href="https://matthewkudija.com/reading.html">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<link rel="stylesheet" href="../assets/css/main.css" />
<link rel="stylesheet" href="../assets/css/bigfoot-default.css" />
</head>
<body>

<!-- Wrapper -->
<div id="wrapper">

<!-- Main -->
<div id="main">
<div class="inner">
<!-- Header -->
<header id="header">
<a href="https://matthewkudija.com/" class="mk"><strong>Matthew Kudija</strong></a> • <a href="https://matthewkudija.com/notes/">Notes</a> • <a href="https://matthewkudija.com/reading-notes/">Reading Notes</a> • <a href="https://matthewkudija.com/reading">Reading List</a>
</header>

<!-- Content -->

<h1 id="sql-code-snippets">SQL Code Snippets</h1>

<h3 id="joins">Joins</h3>

<p><code>on</code></p>

<div class="codehilite"><pre><span></span><code><span class="k">FROM</span><span class="w"> </span><span class="n">information_schema</span><span class="p">.</span><span class="n">tables</span><span class="w"> </span><span class="n">t</span><span class="w"></span>
<span class="w">    </span><span class="k">JOIN</span><span class="w"> </span><span class="n">information_schema</span><span class="p">.</span><span class="n">columns</span><span class="w"> </span><span class="k">c</span><span class="w"> </span>
<span class="w">           </span><span class="k">on</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="k">table_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="k">table_name</span><span class="w"> </span>
<span class="w">           </span><span class="k">and</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">table_schema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">table_schema</span><span class="w"></span>
</code></pre></div>

<p><code>using</code></p>

<div class="codehilite"><pre><span></span><code><span class="k">FROM</span><span class="w"> </span><span class="n">information_schema</span><span class="p">.</span><span class="n">tables</span><span class="w"> </span><span class="n">t</span><span class="w"></span>
<span class="w">    </span><span class="k">JOIN</span><span class="w"> </span><span class="n">information_schema</span><span class="p">.</span><span class="n">columns</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">USING</span><span class="p">(</span><span class="k">table_name</span><span class="p">,</span><span class="w"> </span><span class="n">table_schema</span><span class="p">)</span><span class="w"></span>
</code></pre></div>

<h3 id="find-tables-with-colname-column">Find tables with <code>colName</code> column</h3>

<div class="codehilite"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">table_schema</span><span class="p">,</span><span class="w"></span>
<span class="w">       </span><span class="n">t</span><span class="p">.</span><span class="k">table_name</span><span class="w"></span>
<span class="k">from</span><span class="w"> </span><span class="n">information_schema</span><span class="p">.</span><span class="n">tables</span><span class="w"> </span><span class="n">t</span><span class="w"></span>
<span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">information_schema</span><span class="p">.</span><span class="n">columns</span><span class="w"> </span><span class="k">c</span><span class="w"> </span>
<span class="w">           </span><span class="k">on</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="k">table_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="k">table_name</span><span class="w"> </span>
<span class="w">           </span><span class="k">and</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">table_schema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">table_schema</span><span class="w"></span>
<span class="k">where</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="k">column_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;colName&#39;</span><span class="w"></span>
<span class="w">      </span><span class="k">and</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">table_schema</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;information_schema&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;pg_catalog&#39;</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="k">and</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">table_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;BASE TABLE&#39;</span><span class="w"></span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">table_schema</span><span class="p">;</span><span class="w"></span>
</code></pre></div>

<h3 id="unique-items-in-column">Unique items in <strong><code>column</code></strong></h3>

<div class="codehilite"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span>
<span class="w">    </span><span class="n">t</span><span class="p">.</span><span class="n">device</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span>
<span class="w">    </span><span class="k">database</span><span class="p">.</span><span class="k">table</span><span class="w"> </span><span class="n">t</span><span class="w"></span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">device</span><span class="w"></span>
</code></pre></div>

<table>
<thead>
<tr>
  <th></th>
  <th>device</th>
</tr>
</thead>
<tbody>
<tr>
  <td>1</td>
  <td>"iPhone10,1"</td>
</tr>
<tr>
  <td>2</td>
  <td>"iPhone10,2"</td>
</tr>
<tr>
  <td>3</td>
  <td>"iPhone10,3"</td>
</tr>
<tr>
  <td>4</td>
  <td>"iPhone10,4"</td>
</tr>
<tr>
  <td>5</td>
  <td>"iPhone10,5"</td>
</tr>
</tbody>
</table>

<h3 id="value_count-of-column">value_count of <strong><code>column</code></strong></h3>

<div class="codehilite"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span>
<span class="w">    </span><span class="n">value_count_col</span><span class="w"></span>
<span class="w">    </span><span class="p">,</span><span class="k">COUNT</span><span class="p">(</span><span class="n">id_col</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">value_count</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span>
<span class="w">    </span><span class="k">database</span><span class="p">.</span><span class="k">table</span><span class="w"> </span><span class="n">t</span><span class="w"></span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">DESC</span><span class="w"></span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span>
<span class="w">    </span><span class="n">t</span><span class="p">.</span><span class="n">device</span><span class="w"></span>
<span class="w">    </span><span class="p">,</span><span class="k">COUNT</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">distance</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">value_count</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span>
<span class="w">    </span><span class="k">database</span><span class="p">.</span><span class="k">table</span><span class="w"> </span><span class="n">t</span><span class="w"></span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">device</span><span class="w"></span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">value_count</span><span class="w"> </span><span class="k">DESC</span><span class="w"></span>
</code></pre></div>

<table>
<thead>
<tr>
  <th></th>
  <th>device</th>
  <th>value_count</th>
</tr>
</thead>
<tbody>
<tr>
  <td>1</td>
  <td>iPhone10,5</td>
  <td>23832</td>
</tr>
<tr>
  <td>2</td>
  <td>iPhone10,2</td>
  <td>14553</td>
</tr>
<tr>
  <td>3</td>
  <td>iPhone10,4</td>
  <td>3487</td>
</tr>
<tr>
  <td>4</td>
  <td>iPhone10,3</td>
  <td>3078</td>
</tr>
<tr>
  <td>5</td>
  <td>iPhone10,1</td>
  <td>23</td>
</tr>
</tbody>
</table>

<h3 id="npwhere-equivalent-for-cases"><code>np.where</code> equivalent for cases</h3>

<div class="codehilite"><pre><span></span><code><span class="k">CASE</span><span class="w"></span>
<span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">score</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="mi">24</span><span class="w">  </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;0-24&#39;</span><span class="w"></span>
<span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">score</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="mi">49</span><span class="w">  </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;25-49&#39;</span><span class="w"></span>
<span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">score</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">50</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="mi">74</span><span class="w">  </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;50-74&#39;</span><span class="w"></span>
<span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">score</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">75</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;75-100&#39;</span><span class="w"></span>
<span class="w">    </span><span class="k">ELSE</span><span class="w"> </span><span class="s1">&#39;OTHER&#39;</span><span class="w"></span>
<span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">score_group</span><span class="w"></span>
</code></pre></div>

<h3 id="select-only-firstlast-record-using-rank-over-partition-by">Select only first/last record using <code>RANK() OVER PARTITION BY</code></h3>

<p>In this example, there may be many records for a given <code>user_id</code>, but we only want to select the most recent record for each <code>user_id</code>. Alternatively, we could select the first record by using <code>ASC</code>:</p>

<div class="codehilite"><pre><span></span><code><span class="k">SELECT</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="w">    </span><span class="k">FROM</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"></span>
<span class="w">        </span><span class="p">...</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="w">        </span><span class="p">,</span><span class="n">RANK</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">created_at</span><span class="w"> </span><span class="k">DESC</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">RANK</span><span class="w"></span>
<span class="w">        </span><span class="k">FROM</span><span class="w"></span>
<span class="w">            </span><span class="k">database</span><span class="p">.</span><span class="k">table</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">t</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">RANK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
</code></pre></div>

<h3 id="round">Round</h3>

<p><code>ROUND</code> rounds the number, and if you don't want the additional <code>.000</code> you can <code>CAST</code> as an integer:</p>

<p><code>CAST(ROUND(col_name, 0) AS INT) AS col_name_rounded</code></p>

<h3 id="decile">Decile</h3>

<p>Try the <code>NTILE</code> function (<a target="_blank" href="https://www.geeksforgeeks.org/ntile-function-in-sql-server/">link</a>).</p>

<p>To get actual deciles you can use a <code>CASE</code> statement:</p>

<div class="codehilite"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span>
<span class="w">    </span><span class="n">score_decile</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="n">score_decile</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">count</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="k">CASE</span><span class="w"></span>
<span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;0-9&#39;</span><span class="w"></span>
<span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;10-19&#39;</span><span class="w"></span>
<span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">19</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;20-29&#39;</span><span class="w"></span>
<span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">29</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">40</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;30-39&#39;</span><span class="w"></span>
<span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">39</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">50</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;40-49&#39;</span><span class="w"></span>
<span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">49</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;50-59&#39;</span><span class="w"></span>
<span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">59</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">70</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;60-69&#39;</span><span class="w"></span>
<span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">69</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">80</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;70-79&#39;</span><span class="w"></span>
<span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">79</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">90</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;80-89&#39;</span><span class="w"></span>
<span class="w">            </span><span class="k">WHEN</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;90-100&#39;</span><span class="w"></span>
<span class="w">        </span><span class="k">END</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">score_decile</span><span class="w"></span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="k">database</span><span class="p">.</span><span class="k">table</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">score_decile</span><span class="w"></span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">score_decile</span><span class="w"></span>
</code></pre></div>

<p>A quick trick is to <code>ROUND</code> with <code>-1</code> to approximate deciles if score is in the range from 0-100. This is not exact as your buckets will be <code>0-5</code>, <code>6-15</code>...<code>86-95</code>, <code>96-100</code> so the first and last buckets will be small, but if you are just comparing between two distributions and care less about the absolute distribution, this may be an easy trick.</p>

<div class="codehilite"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span>
<span class="w">    </span><span class="n">score_decile_approx</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="n">score_decile_approx</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">count</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">ROUND</span><span class="p">(</span><span class="n">score</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">score_decile_approx</span><span class="w"></span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="k">database</span><span class="p">.</span><span class="k">table</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">score_decile_approx</span><span class="w"></span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">score_decile_approx</span><span class="w"></span>
</code></pre></div>

<p>Finally, we may want the <em>rate</em> rather than the count, which we can get with the <code>RATIO_TO_REPORT(count) OVER () AS rate</code> command. This gives <code>rate</code> for each row as a fraction of the sum of count <code>count</code> column.</p>

<div class="codehilite"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span>
<span class="w">    </span><span class="n">score_decile_approx</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="n">score_decile_approx</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">count</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">RATIO_TO_REPORT</span><span class="p">(</span><span class="k">count</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">rate</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">ROUND</span><span class="p">(</span><span class="n">unmapped_score</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">score_decile_approx</span><span class="w"></span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="k">database</span><span class="p">.</span><span class="k">table</span><span class="w"></span>

<span class="p">)</span><span class="w"></span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">score_decile_approx</span><span class="w"></span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">score_decile_approx</span><span class="w"></span>
</code></pre></div>

<h3 id="ratio-over-groupby">Ratio over groupby</h3>

<p>Above we use the <code>RATIO_TO_REPORT</code> command to get a ratio rather than count. If we want a time series showing percent, and it is groupe by time (week, month, etc.), this is how you get a rate for each group rather than the whole table:</p>

<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">RATIO_TO_REPORT</span><span class="p">(</span><span class="n">account_count</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">account_timestamp</span><span class="p">))</span><span class="w"></span>
</code></pre></div>

<p>or</p>

<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">&#39;quarter&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">account_timestamp</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">RATIO_TO_REPORT</span><span class="p">(</span><span class="n">account_count</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"></span>
</code></pre></div>

<h3 id="number-of-items-and-most-recent-in-table">Number of items and most recent in table</h3>

<div class="codehilite"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span>
<span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">),</span><span class="w"> </span>
<span class="w">    </span><span class="k">MAX</span><span class="p">(</span><span class="n">created_at</span><span class="p">)</span><span class="w"> </span>
<span class="k">FROM</span><span class="w"> </span>
<span class="w">    </span><span class="k">database</span><span class="p">.</span><span class="k">table</span><span class="w"></span>
</code></pre></div>

<h3 id="rolling-mean">Rolling Mean</h3>

<div class="codehilite"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span>
<span class="w">    </span><span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">&#39;day&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">profile_timestamp</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">account_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">new_user_count</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">AVG</span><span class="p">(</span><span class="n">new_user_count</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">ROWS</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">PRECEDING</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="k">CURRENT</span><span class="w"> </span><span class="k">ROW</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">count_rolling</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span>
<span class="w">    </span><span class="k">database</span><span class="p">.</span><span class="k">table</span><span class="w"></span>
</code></pre></div>

<h3 id="percent-change">Percent Change</h3>

<p>Display the <code>%</code> symbol:</p>

<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="n">CONCAT</span><span class="p">(</span><span class="n">ROUND</span><span class="p">((</span><span class="n">edw_PLE_months_30_4</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">edw_PLE_months_30</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">edw_PLE_months_30</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span><span class="s1">&#39;\%&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">percent_diff</span><span class="w"></span>
</code></pre></div>

<h3 id="percent-of-total">Percent of Total</h3>

<div class="codehilite"><pre><span></span><code><span class="n">earned_premium</span><span class="o">/</span><span class="k">SUM</span><span class="p">(</span><span class="n">earned_premium</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">percent_of_total</span><span class="w"></span>
</code></pre></div>

<p>or</p>

<div class="codehilite"><pre><span></span><code><span class="n">RATIO_TO_REPORT</span><span class="p">(</span><span class="n">earned_premium</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">percent_of_total</span><span class="w"></span>
</code></pre></div>

<h3 id="optimize-query">Optimize Query</h3>

<p>If you run the query with <code>EXPLAIN</code> on top it will give you the query plan and how costly each step is.</p>

<h3 id="most-recent-month-end-date">Most Recent Month-End Date</h3>

<div class="codehilite"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="n">DATEADD</span><span class="p">(</span><span class="k">DAY</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">CURRENT_DATE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">most_recent_month_end_date</span><span class="w"></span>
</code></pre></div>

<h3 id="creatingupdating-tables">Creating/Updating Tables</h3>

<p>Create table:</p>

<div class="codehilite"><pre><span></span><code><span class="c1">-- create table</span>
<span class="k">DROP</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="k">schema</span><span class="p">.</span><span class="k">table</span><span class="p">;</span><span class="w"></span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">schema</span><span class="p">.</span><span class="k">table</span><span class="w"></span>
<span class="w">    </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="k">table</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
</code></pre></div>

<p>Update table:</p>

<div class="codehilite"><pre><span></span><code><span class="k">DELETE</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="k">table</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="k">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;a&#39;</span><span class="p">;</span><span class="w"></span>

<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="k">table</span><span class="w"></span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">source_table</span><span class="w"></span>
</code></pre></div>

<p>Grant usage:</p>

<div class="codehilite"><pre><span></span><code><span class="k">GRANT</span><span class="w"> </span><span class="k">USAGE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="k">user</span><span class="p">;</span><span class="w"></span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="n">TABLES</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="o">&lt;</span><span class="n">name</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="k">user</span><span class="p">;</span><span class="w"></span>

<span class="k">GRANT</span><span class="w"> </span><span class="k">USAGE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="n">readonly</span><span class="p">;</span><span class="w"></span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="n">TABLES</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="k">SCHEMA</span><span class="w"> </span><span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="n">readonly</span><span class="p">;</span><span class="w"></span>
</code></pre></div>

<h3 id="view-tables-in-schema">View Tables in Schema</h3>

<div class="codehilite"><pre><span></span><code><span class="c1">-- view tables in schema</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="k">table_name</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span><span class="n">information_schema</span><span class="p">.</span><span class="n">tables</span><span class="w"> </span><span class="n">t</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">table_schema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;schema&#39;</span><span class="w"> </span><span class="c1">-- put schema name here</span>
<span class="w">    </span><span class="k">AND</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">table_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;BASE TABLE&#39;</span><span class="w"></span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="k">table_name</span><span class="p">;</span><span class="w"></span>
</code></pre></div>

<h3 id="lag-offset-column-by-n-rows">Lag (Offset column by n rows)</h3>

<div class="codehilite"><pre><span></span><code><span class="k">SELECT</span><span class="w"></span>
<span class="w">    </span><span class="n">col</span><span class="w"></span>
<span class="w">    </span><span class="n">LAG</span><span class="p">(</span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">calendar_month</span><span class="w"> </span><span class="k">ASC</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">col_lag_7</span><span class="w"></span>
</code></pre></div>

<h3 id="development-months-and-terms">Development Months and Terms</h3>

<p><code>dev_mo</code> starts at 0, <code>term</code> starts at 1:</p>

<div class="codehilite"><pre><span></span><code><span class="p">,</span><span class="w"> </span><span class="n">DATEDIFF</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">policy_effective_month</span><span class="p">,</span><span class="w"> </span><span class="n">calendar_month</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">dev_month</span><span class="w">  </span>
<span class="p">,</span><span class="w"> </span><span class="n">dev_month</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">term</span><span class="w"></span>
</code></pre></div>

<h2 id="dates">Dates</h2>

<h3 id="last-7-days-of-data">Last 7 days of data</h3>

<div class="codehilite"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span>
<span class="w">    </span><span class="o">*</span><span class="w"></span>
<span class="k">FROM</span><span class="w"> </span>
<span class="w">    </span><span class="k">database</span><span class="p">.</span><span class="k">table</span><span class="w"> </span><span class="n">t</span><span class="w"></span>
<span class="k">WHERE</span><span class="w"></span>
<span class="w">    </span><span class="n">t</span><span class="p">.</span><span class="n">created_at</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">GETDATE</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">INTERVAL</span><span class="w"> </span><span class="s1">&#39;7 days&#39;</span><span class="w"></span>
</code></pre></div>

<h3 id="date_trunc">DATE_TRUNC</h3>

<p>To transform a timestamp into weekly or daily etc. data use <code>DATE_TRUNC()</code>. Available <code>datepart</code>s are listed <a target="_blank" href="http://www.postgresqltutorial.com/postgresql-date_trunc/">here</a>.</p>

<div class="codehilite"><pre><span></span><code><span class="k">SELECT</span><span class="w"></span>
<span class="w">    </span><span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">&#39;day&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">timestamp</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">day</span><span class="w"></span>
</code></pre></div>

<p>or </p>

<div class="codehilite"><pre><span></span><code><span class="k">SELECT</span><span class="w"></span>
<span class="w">    </span><span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">&#39;week&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">timestamp</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">week</span><span class="w"></span>
</code></pre></div>

<p>or</p>

<div class="codehilite"><pre><span></span><code><span class="k">SELECT</span><span class="w"></span>
<span class="w">    </span><span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">timestamp</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">month</span><span class="w"></span>
</code></pre></div>

<p>or</p>

<div class="codehilite"><pre><span></span><code><span class="k">SELECT</span><span class="w"></span>
<span class="w">    </span><span class="n">DATE_TRUNC</span><span class="p">(</span><span class="s1">&#39;quarter&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">timestamp</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">quarter</span><span class="w"></span>
</code></pre></div>

<h3 id="get-month-offset-from-current-date-also-end-of-month">Get month offset from current date (also end of month)</h3>

<ul>
<li><code>CURRENT_DATE</code> to get current date</li>
<li><code>DATEADD</code> to offset by a number of months</li>
<li><code>LAST_DAY</code> to get last day of month</li>
</ul>

<div class="codehilite"><pre><span></span><code><span class="n">policy_inception_month</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LAST_DAY</span><span class="p">(</span><span class="n">DATEADD</span><span class="p">(</span><span class="n">MM</span><span class="p">,</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="k">CURRENT_DATE</span><span class="p">))</span><span class="w"></span>
</code></pre></div>

<p><em>or</em></p>

<div class="codehilite"><pre><span></span><code><span class="k">WHERE</span><span class="w"> </span><span class="n">prediction_date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LAST_DAY</span><span class="p">(</span><span class="n">DATE_ADD</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="k">CURRENT_DATE</span><span class="p">))</span><span class="w"></span>
</code></pre></div>

<h3 id="current-date">Current Date</h3>

<div class="codehilite"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="k">LEFT</span><span class="p">(</span><span class="n">GETDATE</span><span class="p">(),</span><span class="mi">10</span><span class="p">)</span><span class="w"></span>
</code></pre></div>

<hr />

<p>Created: <text style="background-color: whitesmoke; color: #23537d;">2019-06-25-Tue</text><br />
Updated: 2022-02-24-Thu</p>


</div>

<div class="div-feedback">
<p>
<em>Drop drop me a note to share your thoughts:</em> <code><a href="mailto:m.kudija@gmail.com">m.kudija@gmail.com</a></code>
</p>
</div>
</div>
</div>

<!-- Scripts -->
<script src="../assets/js/jquery.min.js"></script>
<script type="text/javascript" src="../assets/js/bigfoot.js"></script>
<script type="text/javascript">
$.bigfoot (
{

}
);
</script>
</body>
<hr>
<footer id="footer" align="center">
<center>
<img src="../images/kudija_family_shield.png" width=100px>
<p class="copyright">&copy; 2005<script>new Date().getFullYear()>2005&&document.write("–"+new Date().getFullYear());</script> Matthew Kudija • <a href="https://github.com/mkudija/mkudija.github.io/" target="_blank">Source</a></p>
</center>
</footer>
</html>
